name: Update Homebrew Formula

on:
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Wait for release assets
      run: |
        echo "Waiting for release assets to be available..."
        sleep 60

    - name: Download and calculate checksums
      id: checksums
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        BASE_URL="https://github.com/Linuxdazhao/cc_auto_switch/releases/download/v${VERSION}"
        
        # Download and calculate checksums for all platforms
        curl -sL "${BASE_URL}/cc-switch-x86_64-apple-darwin.tar.gz" | sha256sum | cut -d' ' -f1 > mac_intel_sha.txt
        curl -sL "${BASE_URL}/cc-switch-aarch64-apple-darwin.tar.gz" | sha256sum | cut -d' ' -f1 > mac_arm_sha.txt
        curl -sL "${BASE_URL}/cc-switch-x86_64-unknown-linux-gnu.tar.gz" | sha256sum | cut -d' ' -f1 > linux_intel_sha.txt
        curl -sL "${BASE_URL}/cc-switch-aarch64-unknown-linux-gnu.tar.gz" | sha256sum | cut -d' ' -f1 > linux_arm_sha.txt
        
        # Set outputs
        echo "mac_intel_sha=$(cat mac_intel_sha.txt)" >> $GITHUB_OUTPUT
        echo "mac_arm_sha=$(cat mac_arm_sha.txt)" >> $GITHUB_OUTPUT
        echo "linux_intel_sha=$(cat linux_intel_sha.txt)" >> $GITHUB_OUTPUT
        echo "linux_arm_sha=$(cat linux_arm_sha.txt)" >> $GITHUB_OUTPUT

    - name: Checkout tap repository
      uses: actions/checkout@v4
      with:
        repository: Linuxdazhao/homebrew-cc-switch
        token: ${{ secrets.GITHUB_TOKEN }}
        path: homebrew-cc-switch

    - name: Update formula
      run: |
        cd homebrew-cc-switch
        VERSION="${{ steps.version.outputs.version }}"
        
        # Update the formula file
        sed -i "s/version \".*\"/version \"${VERSION}\"/" Formula/cc-switch.rb
        sed -i "s/PLACEHOLDER_X86_64_SHA256/${{ steps.checksums.outputs.mac_intel_sha }}/" Formula/cc-switch.rb
        sed -i "s/PLACEHOLDER_ARM64_SHA256/${{ steps.checksums.outputs.mac_arm_sha }}/" Formula/cc-switch.rb
        sed -i "s/PLACEHOLDER_LINUX_X86_64_SHA256/${{ steps.checksums.outputs.linux_intel_sha }}/" Formula/cc-switch.rb
        sed -i "s/PLACEHOLDER_LINUX_ARM64_SHA256/${{ steps.checksums.outputs.linux_arm_sha }}/" Formula/cc-switch.rb

    - name: Commit and push changes
      run: |
        cd homebrew-cc-switch
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        git add Formula/cc-switch.rb
        git commit -m "Update cc-switch to v${{ steps.version.outputs.version }}

        - Update version to ${{ steps.version.outputs.version }}
        - Update SHA256 checksums for all platforms
        
        ðŸ¤– Auto-updated by GitHub Actions"
        
        git push origin main