---
name: Implement Environment Variable Management
status: open
created: 2025-09-24T00:23:41Z
updated: 2025-09-24T00:33:22Z
github: https://github.com/Linuxdazhao/cc_auto_switch/issues/15
depends_on: [13]
parallel: true
conflicts_with: []
---

# Task: Implement Environment Variable Management

## Description

Extend the ClaudeSettings environment variable handling in `src/cmd/config.rs` to manage the `ANTHROPIC_MAX_THINKING_TOKENS` environment variable. Add support for setting and removing the variable when switching configurations, following the established pattern for model environment variables.

## Acceptance Criteria

- [ ] `remove_anthropic_env()` method removes `ANTHROPIC_MAX_THINKING_TOKENS`
- [ ] `switch_to_config()` method sets `ANTHROPIC_MAX_THINKING_TOKENS` when present
- [ ] Handle u32 to String conversion for environment variable
- [ ] Only set environment variable when thinking tokens are configured
- [ ] Remove environment variable when switching to configs without thinking tokens
- [ ] Preserve existing environment variables during updates
- [ ] Environment variable changes are immediately effective

## Technical Details

**Implementation Approach:**
- Extend `remove_anthropic_env()` method around line 136 in `src/cmd/config.rs`
- Extend `switch_to_config()` method around lines 113-120
- Follow exact pattern used by `ANTHROPIC_SMALL_FAST_MODEL` handling
- Use `.to_string()` method for u32 to String conversion

**Code Locations:**
- `src/cmd/config.rs`: `remove_anthropic_env()` method (line 136)
- `src/cmd/config.rs`: `switch_to_config()` method (lines 113-120)
- `src/cmd/config.rs`: Environment variable building logic (lines 39-46)

**Key Considerations:**
- Environment variable name follows established pattern: `ANTHROPIC_MAX_THINKING_TOKENS`
- Handle None values by not setting the environment variable
- Ensure numeric conversion doesn't fail (u32 to String is safe)
- Maintain compatibility with existing Claude settings.json structure

## Dependencies

- [ ] Task 001: Configuration struct must have max_thinking_tokens field

## Effort Estimate

- **Size**: S
- **Hours**: 1-2 hours
- **Parallel**: true (independent of CLI changes)

## Definition of Done

- [ ] Environment variable correctly set during configuration switches
- [ ] Environment variable properly removed when not needed
- [ ] No conflicts with existing environment variable management
- [ ] Claude CLI recognizes the environment variable changes
- [ ] Settings.json remains valid and properly formatted
- [ ] Integration with existing ClaudeSettings workflow
- [ ] Error handling for environment variable operations
